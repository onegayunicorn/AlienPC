name: Security Shield

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Enforce GPG Signatures (Main Branch)
      run: |
        echo "üõ°Ô∏è Enforcing GPG signatures for main branch..."
        
        # Check all commits in this push
        commits=$(git rev-list ${{ github.event.before }}..${{ github.sha }} 2>/dev/null || echo "")
        
        if [ -z "$commits" ]; then
          echo "‚ö†Ô∏è  No commits to check (first push or empty)"
          exit 0
        fi
        
        unsigned_count=0
        for commit in $commits; do
          if ! git verify-commit "$commit" 2>/dev/null; then
            echo "‚ùå UNSIGNED COMMIT: $commit"
            unsigned_count=$((unsigned_count + 1))
          fi
        done
        
        if [ $unsigned_count -gt 0 ]; then
          echo ""
          echo "üö® SECURITY VIOLATION: $unsigned_count unsigned commit(s) detected"
          echo "Main branch requires GPG-signed commits"
          echo ""
          echo "To fix:"
          echo "  1. git config --global commit.gpgsign true"
          echo "  2. git config --global user.signingkey YOUR_KEY_ID"
          echo "  3. Rebase and sign commits"
          exit 1
        fi
        
        echo "‚úÖ All commits are GPG-signed"
    
    - name: Check for Sensitive Data
      run: |
        echo "üîç Scanning for sensitive data..."
        
        # Check for common secret patterns
        if grep -r -E "(password|secret|token|key).*=.*['\"]" --include="*.py" --include="*.js" --include="*.yml" . ; then
          echo "‚ö†Ô∏è  Potential secrets found - please review"
        else
          echo "‚úÖ No obvious secrets detected"
        fi
    
    - name: Validate Config Security
      run: |
        if [ -f "config/api_keys.env" ]; then
          if grep -q "PLACEHOLDER" config/api_keys.env; then
            echo "‚úÖ Config file contains placeholders (not real keys)"
          else
            echo "‚ö†Ô∏è  Config file may contain real keys - ensure it's in .gitignore"
          fi
        fi
    
    - name: Check .gitignore
      run: |
        if [ -f ".gitignore" ]; then
          echo "‚úÖ .gitignore exists"
          
          # Check for important entries
          required_patterns=(
            "*.env"
            "*.key"
            "*.pem"
            "__pycache__"
            ".vscode"
          )
          
          for pattern in "${required_patterns[@]}"; do
            if grep -q "$pattern" .gitignore; then
              echo "  ‚úÖ Ignoring: $pattern"
            else
              echo "  ‚ö†Ô∏è  Not ignoring: $pattern (consider adding)"
            fi
          done
        else
          echo "‚ùå .gitignore missing - create one!"
          exit 1
        fi
