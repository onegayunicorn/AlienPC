name: Omega Evolution Validation

on:
  pull_request:
    branches: [ omega-evolution, main ]
  push:
    branches: [ omega-evolution ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for signature verification
    
    - name: Verify Repository Structure
      run: |
        echo "üîç Verifying directory structure..."
        
        required_dirs=(
          "council"
          "genomics"
          "device-profiles"
          "docs"
          "scripts"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "‚úÖ $dir exists"
          else
            echo "‚ùå $dir missing"
            exit 1
          fi
        done
    
    - name: Verify GPG Signatures
      run: |
        echo "üîê Checking commit signatures..."
        
        # Check last 5 commits for signatures
        for commit in $(git log --format="%H" -5); do
          if git verify-commit "$commit" 2>/dev/null; then
            echo "‚úÖ Commit $commit is signed"
          else
            echo "‚ö†Ô∏è  Commit $commit is NOT signed"
          fi
        done
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "‚ö†Ô∏è  No requirements.txt found, skipping"
        fi
    
    - name: Run Tests
      run: |
        if [ -d "genomics/tests" ]; then
          pip install pytest pytest-cov
          pytest genomics/tests/ -v || echo "‚ö†Ô∏è  Tests failed or not found"
        else
          echo "‚ö†Ô∏è  No test directory found"
        fi
    
    - name: Validate Protocol Files
      run: |
        echo "üß¨ Validating protocol files..."
        
        if [ -d "genomics/planetary-healing/dmd" ]; then
          for file in genomics/planetary-healing/dmd/*.json; do
            if [ -f "$file" ]; then
              if python -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚úÖ Valid JSON: $file"
              else
                echo "‚ùå Invalid JSON: $file"
                exit 1
              fi
            fi
          done
        fi
    
    - name: Check Council Quorum
      run: |
        if [ -f "council/quorum.json" ]; then
          echo "üìú Verifying council quorum..."
          python -c "
import json, sys

with open('council/quorum.json') as f:
    quorum = json.load(f)

required_fields = ['council_members', 'min_ethics_score', 'required_signatures']
for field in required_fields:
    if field not in quorum:
        print(f'‚ùå Missing field: {field}')
        sys.exit(1)

print('‚úÖ Council quorum valid')
print(f'   Members: {len(quorum.get(\"council_members\", []))}')
print(f'   Min Ethics: {quorum.get(\"min_ethics_score\")}')
print(f'   Required Signatures: {quorum.get(\"required_signatures\")}')
          "
        fi
    
    - name: Generate Report
      if: always()
      run: |
        echo "üìä Validation Report"
        echo "===================="
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Timestamp: $(date -u)"
